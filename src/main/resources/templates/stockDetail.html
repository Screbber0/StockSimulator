<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="'Stock Detail: ' + ${stock.companyName}">Stock Detail</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .stock-info-container {
            margin-bottom: 20px;
        }
        .stock-info-container h1 {
            margin: 0 0 10px 0;
        }
        .price-info {
            font-size: 1.2em;
        }
        .tradingview-container {
            margin-top: 30px;
        }
        .text-green {
            color: green;
        }
        .text-red {
            color: red;
        }
        /* Примерный стиль для canvas */
        #myCandleChart {
            max-width: 800px;
            max-height: 400px;
        }
    </style>
</head>
<body>

<div class="stock-info-container">
    <h1 th:text="${stock.companyName}">Company Name</h1>
    <p><strong>Ticker:</strong> <span th:text="${stock.ticker}">SBER</span></p>
    <p class="price-info">
        <strong>Current Price:</strong>
        <span th:text="${stock.currentPrice}"></span>₽
        &nbsp;
        <span th:if="${stock.change != null}">
        (<span th:text="${stock.change.signum() > 0 ? '+' : ''} + ${stock.change} + '₽'"
               th:classappend="${stock.change.signum() >= 0 ? 'text-green' : 'text-red'}">
        </span>)
    </span>
        &nbsp;
        <span th:if="${stock.changePercent != null}">
        <span th:text="${stock.changePercent.signum() > 0 ? '+' : ''} + ${stock.changePercent} + '%'"
              th:classappend="${stock.changePercent.signum() >= 0 ? 'text-green' : 'text-red'}">
        </span>
    </span>
    </p>
    <p><strong>Day High:</strong> <span th:text="${stock.dayHigh}">0</span></p>
    <p><strong>Day Low:</strong> <span th:text="${stock.dayLow}">0</span></p>
    <p><strong>Volume:</strong> <span th:text="${stock.volume}">0</span></p>
</div>

<!-- Ссылка на TradingView -->
<div class="tradingview-container">
    <a th:href="'https://www.tradingview.com/symbols/MOEX:' + ${stock.ticker}"
       target="_blank"
       rel="noopener noreferrer">
        Открыть график на TradingView
    </a>
</div>

<!-- Наш canvas для отображения графика, построенного на данных Tinkoff -->
<canvas id="myCandleChart" width="800" height="400"></canvas>

<!-- Подключаем Chart.js (или Chart.js + Financial plugin) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Если хотите рисовать свечной график, нужен плагин:
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-financial@0.1.0"></script>
-->

<script th:inline="javascript">
    /*<![CDATA[*/

    // 1) Получаем JSON-данные о свечах, которые вернул контроллер
    let rawCandles = /*[[${candlesJson}]]*/ '[]';
    let candleArray = JSON.parse(rawCandles);

    // candleArray = [
    //   { "time": "2025-03-12T08:00:00Z", "open":100, "high":105, "low":95, "close":102 },
    //   ...
    // ]
    // или "time" - Instant; возможно, "time":"2025-03-12T08:00:00Z"

    console.log("Loaded candle data = ", candleArray);

    // 2) Пример: построим линейный график по CLOSE
    let labels = candleArray.map(c => c.time.substring(0, 16)); // обрезаем до "2025-03-12T08:00"
    let closeValues = candleArray.map(c => c.close);

    let ctx = document.getElementById('myCandleChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Close price',
                data: closeValues,
                borderColor: 'blue',
                borderWidth: 2,
                fill: false
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: false }
            }
        }
    });
    /*]]>*/
</script>

</body>
</html>
